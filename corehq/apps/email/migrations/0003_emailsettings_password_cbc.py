# Generated by Django 4.2.16 on 2024-11-19 20:16

from django.db import migrations

from corehq.motech.const import ALGO_AES
from corehq.util.django_migrations import skip_on_fresh_install
from corehq.motech.utils import reencrypt_ecb_to_cbc_mode


@skip_on_fresh_install
def copy_and_reencrypt_password_to_password_cbc(apps, schema_editor):
    EmailSettings = apps.get_model('email', 'EmailSettings')

    for email_settings in EmailSettings.objects.all():
        email_settings.password = reencrypt_ecb_to_cbc_mode(email_settings.password, f'${ALGO_AES}$')
        email_settings.save()


class Migration(migrations.Migration):

    dependencies = [
        ('email', '0002_emailsettings_return_path_email'),
    ]

    operations = [
        migrations.RunPython(copy_and_reencrypt_password_to_password_cbc, migrations.RunPython.noop),
    ]

{% extends "hqwebapp/bootstrap5/base_section.html" %}
{% load hq_shared_tags %}
{% load i18n %}


{% block js %}{{ block.super }}
  <script src="{% static 'moment/moment.js' %}"></script>
  <script src="{% static 'app_execution/js/workflow_timing_chart.js' %}"></script>
{% endblock %}

{% block page_content %}
  <h2>Logs for workflow "<a href="{% url "app_execution:edit_workflow" workflow.id %}">{{ workflow.name }}</a>"</h2>
  <div class="">
    <h3>{% trans "Average Timings Per Hour" %}</h3>
    <div id="timing_linechart"><svg height="300px"></svg></div>
  </div>
  <div id="workflow-logs">
  <table class="table table-striped table-hover">
  <thead>
  <tr>
    <th>Status</th>
    <th>Started</th>
    <th>Duration</th>
    <th></th>
  </tr>
  </thead>
  <tbody data-bind="foreach: items">
  <tr>
    <td><span class="badge"
              data-bind="
                text: success ? 'success' : 'error',
                css: {'text-bg-success': success, 'text-bg-danger': !success}
              ">
    </span></td>
    <td data-bind="text: started"></td>
    <td data-bind="text: duration"></td>
    <td><a class="btn btn-primary" data-bind="attr: {href: url}">Details</a></td>
  </tr>
  </tbody>
  </table>
  <pagination data-apply-bindings="false"
              params="goToPage: goToPage, totalItems: totalItems, perPage: perPage, onLoad: onLoad"></pagination>
</div>
{{ chart_data|json_script:"chart_data" }}
{% endblock %}
{% block js-inline %} {{ block.super }}
<script>
  $(function () {
    let logsModel = function () {
      let self = {};

      self.items = ko.observableArray();
      self.totalItems = ko.observable({{ total }});
      self.perPage = ko.observable(25);
      self.goToPage = function (page) {
        let params = {page: page, per_page: self.perPage()};
        $.getJSON("{% url "app_execution:logs_json" workflow.id %}", params, function (data) {
              self.items(data.logs);
          });
      };

      self.onLoad = function () {
        self.goToPage(1);
      };

      return self;
    };

    $("#workflow-logs").koApplyBindings(logsModel());
  });
</script>
{% endblock %}
